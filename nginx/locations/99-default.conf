# Default catch-all location â€” proxies all unmatched requests to the app
location / {
    limit_req zone=api_limit burst=20 nodelay;

    # Proxy to active backend (blue or green)
    proxy_pass http://active_app;

    # Include common proxy settings
    include /etc/nginx/includes/proxy_headers.conf;
    include /etc/nginx/includes/proxy_params.conf;

    # Extended timeouts for default location (handles longer API requests)
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Intercept errors and redirect to custom handler
    proxy_intercept_errors on;
    error_page 502 503 504 = @service_unavailable;
}

# Custom error handler for unavailable service (all backends down)
location @service_unavailable {
    # Re-include security headers for error responses
    include /etc/nginx/includes/security_headers_enhanced.conf;

    default_type application/json;
    return 503 '{"error":"Service temporarily unavailable","message":"All backend servers are currently down"}';
    add_header Content-Type application/json always;
    add_header Retry-After 30 always;
}
